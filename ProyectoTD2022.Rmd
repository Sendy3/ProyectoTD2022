---
# Ver https://bookdown.org/yihui/rmarkdown/ 
title: "Mini Proyecto 2022. Contaminación acústica en el barrio de Ruzafa"
subtitle: Tratamiento de Datos. Grado en Ciencia de Datos- UV
author: "Sandra Paniagua Sanchez, Máximo Valero,Sergio Cabral, Antonio Hernando Graboleda, Mauro Marín Aura"
date:  "`r Sys.Date()`"  #Pondría la fecha del día actual
params:
  lang: ES
lang: "`r switch(params$lang, ES = 'es-ES', EN = 'en-US')`"
output:
  pdf_document: default
  word_document: default
  html_document: default
---

\bigskip

\bigskip

\noindent\makebox[\linewidth]{\rule{\textwidth}{0.4pt}}

\bigskip

\tableofcontents

\bigskip

\noindent\makebox[\linewidth]{\rule{\textwidth}{0.4pt}}


\newpage

# Informacion de cada columna

RecvTime: Dato proporcionado por la plataforma de ciudad VLCi. Fecha en la que se insertó el dato en la plataforma.

FiwareServicePath: Dato proporcionado por la plataforma de ciudad VLCi. Servicio de la plataforma VLCi al que pertenece el sensor.

EntityType: Dato proporcionado por la plataforma de ciudad VLCi. Tipo de entidad del sensor en la plataforma VLCi.

EntityId: Dato proporcionado por la plataforma de ciudad VLCi. Identificador único del sensor en la plataforma VLCi.

LAeq: Nivel sonoro continuo equivalente. Se define en la ISO 1996-2:2017 como el valor del nivel de presión en dBA en ponderación A de un sonido estable que en un intervalo de tiempo T posee la misma presión sonora cuadrática media que el sonido que se mide y cuyo nivel varía con el tiempo. En este caso el período establecida para este sensor es de 1 minuto.

LAeq_d: Es un indicador de ruido asociado al día, donde al día le corresponden 12 horas, en el período que se extiende desde las 7 hasta las 19 horas.

LAeq_den: índice de ruido día-tarde-noche, es utilizado para determinar la molestia vinculada a la exposición al ruido.

LAeq_e: Es un indicador del nivel sonoro durante la tarde, donde a la tarde le corresponden 4 horas, en el período que se extiende desde las 19 hasta las 23 horas.

LAeq_n: Es un indicador del nivel sonoro durante la noche, donde a la noche le corresponden 8 horas, en el período que se extiende desde las 23 hasta las 7 horas.

Dateobserved: Día al que se refieren las medidas.


```{r setup, cache = F, echo = F, message = F, warning = F, tidy = F}

# CONFIGURACIÓN GENERAL
library(knitr)
options(width = 100)

# Opciones generales de los chucks. Se utilizarán salvo cambios en el chunk
opts_chunk$set(echo=F, message = F, error = F, warning = F, comment = NA, fig.align = 'center', dpi = 200, tidy = F, cache.path = '.cache/', fig.path = './figura/')

# Opciones generales de dígitos cuando se incluyen tablas
#options(xtable.type = 'html')
knit_hooks$set(inline = function(x) {
  
  if(is.numeric(x)) {
    round(x, getOption('digits'))
  } else {
    paste(as.character(x), collapse = ', ')
  }
})
#knit_hooks$set(plot = knitr:::hook_plot_html)
```

Instalación automática de paquetes


```{r include= F}

# Especificamos las librerías necesarias en esta lista

packages = c("tidyverse","knitr", "lubridate", "readr", "dplyr", "forcats", "lubridate", "magrittr", "stringr", "tibble", "tidyr", "tidyverse", "base", "datasets")

#use this function to check if each package is on the local machine
#if a package is installed, it will be loaded
#if any are not, the missing package(s) will be installed and loaded
package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE,repos='http://cran.rediris.es')
  }
  library(x, character.only = TRUE)
})

#verify they are loaded
search()

```

# Introducción del trabajo

El objetivo de este trabajo es analizar los datos recogidos por sensores que monitorizan el nivel de ruido en diferentes localizaciones del barrio de Ruzafa. Los datos los hemos obtenido gracias a que están disponibles en la plataforma de datos abiertos del Ayuntamiento de Valencia, dentro de la categoría medio ambiente.

# Importacion de datos

```{r}
library(readr)
filename <- "data/Ruzafa1.csv"
download.file(url='https://opendata.vlci.valencia.es/datastore/dump/a54fb175-8013-460a-a2f0-22de7a210d7a?format=csv&bom=true', destfile = filename)
Ruzafa1 <- read.csv(filename)
save(file= filename, Ruzafa1)


filename <- "data/Cadiz16.csv"
download.file(url="https://opendata.vlci.valencia.es/datastore/dump/75a878a9-2bd9-4619-98ec-3224be867c65?format=csv&bom=true", destfile = filename)
Cadiz16 <- read_csv(filename)


filename <- "data/Cadiz3.csv"
download.file(url="https://opendata.vlci.valencia.es/datastore/dump/6fa5210b-f9c7-47c8-9d1f-ddb7568f62de?format=csv&bom=true", destfile = filename)
Cadiz3 <- read_csv(filename)


filename <- "data/Cuba3.csv"
download.file(url="https://opendata.vlci.valencia.es/datastore/dump/5a050cef-1107-4b3b-8e61-5daf5cfb2ca4?format=csv&bom=true", destfile = filename)
Cuba3 <- read_csv(filename)

filename <- "data/Sueca2.csv"
download.file(url="https://opendata.vlci.valencia.es/datastore/dump/e580f492-a2f6-4305-af24-f4c4d05b911c?format=csv&bom=true", destfile = filename)
Sueca2 <- read_csv(filename)

filename <- "data/Sueca61.csv"
download.file(url="https://opendata.vlci.valencia.es/datastore/dump/8058f1a5-c605-4baa-afff-2f638efb767f?format=csv&bom=true", destfile = filename)
Sueca61 <- read_csv(filename)

filename <- "data/Sueca32.csv"
download.file(url="https://opendata.vlci.valencia.es/datastore/dump/d842601d-35b4-4b88-96f7-42e8f68e1b74?format=csv&bom=true", destfile = filename)
Sueca32 <- read_csv(filename)

filename <- "data/Maria.csv"
download.file(url="https://opendata.vlci.valencia.es/datastore/dump/ea008906-e06a-4c72-9fe6-3238e212aae4?format=csv&bom=true", destfile = filename)
Maria <- read_csv(filename)

filename <- "data/Serrano.csv"
download.file(url="https://opendata.vlci.valencia.es/datastore/dump/64e4b7b4-e633-4753-b0ef-a57d785076f8?format=csv&bom=true", destfile = filename)
Serrano <- read_csv(filename)

filename <- "data/Cadiz.csv"
download.file(url="https://opendata.vlci.valencia.es/datastore/dump/ff8678b6-748e-4908-ab5b-9c7ff567da61?format=csv&bom=true", destfile = filename)
Cadiz <- read_csv(filename)

filename <- "data/Cervera34.csv"
download.file(url="https://opendata.vlci.valencia.es/datastore/dump/b26d42ae-2be9-481a-9b79-71392d9e80bd?format=csv&bom=true", destfile = filename)
Cervera34 <- read_csv(filename)

filename <- "data/Rico21.csv"
download.file(url="https://opendata.vlci.valencia.es/datastore/dump/1b41d86b-3939-488b-9035-92d851245924?format=csv&bom=true", destfile = filename)
Rico21 <- read_csv(filename)

filename <- "data/Serrano21.csv"
download.file(url="https://opendata.vlci.valencia.es/datastore/dump/784f4732-abc5-41b1-857b-42decb306643?format=csv&bom=true", destfile = filename)
Serrano21 <- read_csv(filename)

filename <- "data/Cortes.csv"
download.file(url="https://opendata.vlci.valencia.es/datastore/dump/3b2fe345-08fc-49d7-85c8-8cccf6a7e814?format=csv&bom=true", destfile = filename)
Cortes <- read_csv(filename)

```
# Asegurarse de que tienen el mismo numero de columnas
Para comprobar que todos tienen el mismo numero de columnas y similar numero de observaciones hacemos un bucle for de la lista de archivos a observar.

```{r}

archivos <- list(Ruzafa1, Cadiz16, Cadiz, Cadiz3, Cervera34, Cortes, Maria, Rico21, Serrano, Serrano21, Sueca2, Sueca32, Sueca61)

for (i in archivos){
  print(dim(i))
}

```

#  Asegurarse de que las fechas estan en el formato correcto
```{r}
for (i in archivos){
  i$recvTime <- ymd_hms(i$recvTime)
  i$dateObserved <- ymd(i$dateObserved)
}
Ruzafa1$recvTime <- ymd_hms(Ruzafa1$recvTime)
Ruzafa1$dateObserved <- ymd(Ruzafa1$dateObserved)
```


# 4. Unir dataframes
```{r}
datos <- full_join(Cadiz16, Cadiz, by = NULL) %>% full_join(Cadiz3) %>% full_join(Cervera34) %>%  full_join(Cortes) %>% full_join(Maria) %>% full_join(Rico21) %>%  full_join(Serrano) %>% full_join(Serrano21) %>% full_join(Sueca2) %>%  full_join(Sueca32) %>%  full_join(Sueca61) %>% full_join(Ruzafa1)
```

# 5. Formato tidy
```{r}

tidy <- datos %>% select(starts_with("LA"), dateObserved, entityId, recvTime) %>% gather( key = "Nivel sonoro continuo equivalente", value = "Valores", starts_with("LA"))

```

# Cambiar los nombres de identidad por el nombre de cada calle

```{r echo = T}
tidy$entityId[tidy$entityId == "T248677-daily"]<- "Cadiz"
tidy$entityId[tidy$entityId == "T248671-daily"]<- "Cadiz16"
tidy$entityId[tidy$entityId == "T248655-daily"]<- "Cadiz3"
tidy$entityId[tidy$entityId == "T248678-daily"]<- "Cervera34"
tidy$entityId[tidy$entityId == "T248661-daily"]<- "Cortes"
tidy$entityId[tidy$entityId == "T248655-daily"]<- "Cuba3"
tidy$entityId[tidy$entityId == "T248670-daily"]<- "Maria"
tidy$entityId[tidy$entityId == "T248672-daily"]<- "Rico21"
tidy$entityId[tidy$entityId == "T248652-daily"]<- "Ruzafa1"
tidy$entityId[tidy$entityId == "T248676-daily"]<- "Serrano"
tidy$entityId[tidy$entityId == "T248669-daily"]<- "Serrano21"
tidy$entityId[tidy$entityId == "T248683-daily"]<- "Sueca2"
tidy$entityId[tidy$entityId == "T248680-daily"]<- "Sueca32"
tidy$entityId[tidy$entityId == "T248684-daily"]<- "Sueca61"



```



# 6. Graficos

Primero buscamos los valores infinitos de nuestro data.frame Y seleccionamos los que son distintos de infinito.
```{r}
tidy_infinitos <- tidy %>% filter(Valores == Inf)

tidy_sininfinitos <- tidy %>% filter(Valores != Inf)
```

Cambiamos aquellos que tengan Inf por un valor muy alto que hemos considerado que seria 100.
```{r}
tidy_infinitos$Valores[tidy_infinitos$Valores== Inf]<- 100

```

Por ultimo, actualizamos el data.frame tidy con los valores cambiados
```{r}
tidy <- rbind(tidy_sininfinitos, tidy_infinitos)
```



# Extrer la tabla de datos numericos
```{r}
library(magrittr)

myvars <- c("LAeq", "LAeq_d", "LAeq_den", "LAeq_e", "LAeq_n")

#Estadisticos Ruzafa1 con dos decimales
valores_Ruzafa1 <- Ruzafa1 %>% gather(key = "tipo", value = "Valor", myvars) %>%select(ï.._id, tipo, Valor) %>% group_by(tipo) %>% summarise("Valor minimo" = min(Valor, na.rm=TRUE), Percentil25 = quantile(probs = 1/4, Valor, na.rm=TRUE), Mediana = median(Valor, na.rm=TRUE), "Valor medio" = mean(Valor, na.rm=TRUE), "Desviació típica" = sd(Valor, na.rm=TRUE), Percentil75 = quantile(probs = 3/4, Valor, na.rm=TRUE), "Valor maximo" = max(Valor, na.rm=TRUE)) %>% mutate(across(is.numeric, round, digits=2))
```

#Representacion grafica de los valores agrupados por calle y tipo de toma del sonido
```{r}
library(forcats)

grafico <- valores %>%
  group_by(entityId, `Nivel sonoro continuo equivalente`)  %>% 
  ggplot(aes(fct_reorder(entityId, `Nivel sonoro continuo equivalente`), Media)) + labs(x="Nombre de la calle", y ="Promedio del LA en cada calle", title = "Media de cada LA en cada calle") + geom_col(aes(fill =`Nivel sonoro continuo equivalente`), position = 'dodge')
grafico
ggplotly(grafico)

```


```{r}

s <- tidy %>% group_by(month(dateObserved), `Nivel sonoro continuo equivalente`) %>%summarise(promedio_anual=mean(Valores)) 
#HACER GRAFICO DE ESTE Y DECIR EN QUE AÑO 
```



#Detectar outliers con la regla Hampel

```{r}
reglahampel <- function(x) {
  
  mediana <- median(x, na.rm=T)
  medabdev <- mad(x, na.rm=T)  
  
  lowLim <- mediana-3 *medabdev
  upLim <- mediana+3*medabdev
  
  x < lowLim | x > upLim
  }


metodos <- list(reglahampel=reglahampel)

dirty <- tidy %>% mutate(across(Valores,metodos))

```



```{r}
# Regla boxplot
reglaboxplot <- function(x){
  
  Q25 <- quantile(x, 0.25, na.rm=T)
  Q75 <- quantile(x, 0.75, na.rm=T)
  
  lowLim <- Q25-1.5*IQR(x, na.rm=T)
  upLim <- Q75+1.5*IQR(x, na.rm=T)
  
  x <  lowLim | x > upLim 
  }


# Percentiles
reglapercentil <- function(x){
  
  lowLim <- quantile(x, 0.05, na.rm=T)
  upLim <- quantile(x, 0.95, na.rm=T)
  
  x <  lowLim | x > upLim 
}

metodos <- list(reglahampel=reglahampel, reglaboxplot = reglaboxplot, reglapercentil = reglapercentil)

dirty <- tidy %>% mutate(across(Valores,metodos))

```


#Representacion de los valores outliers
```{r}
dirty %>% 
  pivot_longer(cols = contains("regla"), names_to="regla", values_to="outliers") %>% 
  ggplot(aes(regla, Valores, color=outliers))+ geom_point(position='jitter')

```

Como no hay missing data en el formato tidy, hemos considerado que no hay que imputar en el formato dirty porque seria sustituirlo por la media de cada calle y no aportaria mas informacion.

```{r}
library(readr)
library(plotly)

grafico <- tidy %>% filter(`Nivel sonoro continuo equivalente` == "LAeq_d") %>% ggplot( aes(x = dateObserved, y = Valores, color = entityId)) + geom_line() + labs(title= "Nivel de sonido por dia de cada calle", x = "", y = "", subtitle = "...") + theme_bw() + scale_x_date() + scale_y_continuous(breaks = c(0, 25, 50,65, 75,85, 100)) + scale_x_date(date_labels = format("%b %d, %Y"))

#Mostrar el grafico 
grafico
#Generar un grafico interactivo al compilar en HTML
ggplotly(grafico)

```


# CORRELACIÓN Y VARIANZA
#ARREGLAR ESTOS GRÁFICOS CON LAS NUEVAS VARIABLES (D,M,Y) Y COMPROBAR QUE FUNCIONAN Y DAN RESULTADOS COHERENTES, *COMENTAR LOS RESULTADOS*
```{r}
library(ggplot2)
ggplot(data = datos,
       aes(x = cut(recvTime , breaks = 3), y = LAeq_d)) +
  geom_boxplot()


dsepall <- datos$LAeq_den - mean(datos$LAeq_den)
dsepalw <- datos$LAeq_d - mean(datos$LAeq_d)

ggplot(data.frame(dsepall,dsepalw), aes(x=dsepall, y=dsepalw)) +geom_point() +geom_hline(yintercept=0, linetype="dashed", color = "red") +geom_vline(xintercept=0, linetype="dashed", color = "red") +theme_minimal()

ggplot(iris, aes(x=dsepall, y=dsepalw, shape=dsepalw)) +geom_point() +geom_smooth(method=lm, se=F, fullrange=F)+scale_color_brewer(palette="Dark2")+theme_minimal() +stat_ellipse(type = "norm")


ggplot(data = datos, aes(x = dateObserved, y = datos$LAeq)) +geom_point() +facet_wrap(~ datos)

pairs(Ruzafa1$dateObserved~Ruzafa1$LAeq)
pairs(Serrano$dateObserved~Serrano$LAeq)
# HACER EL PAIRS CON DISTINTAS VARIABLES Y COMENTAR
```


# PREGUNTAS: (hay que responderlas apoyándose de las instrucciones y/o gráficas de R)
"""
-¿Qué año hubo más ruido en Fallas? (Entre Sept 21 y Mar 22), comparar y mostrar los gráficos.
-En general,¿hubo más ruido en 2021 o en 2022?
-¿En qué més del año hubo mayor ruido por la noche?
-¿Como afectó la cuarentena al nivel de ruido? Hacer gráfica comparativa de 2020 y 2022 por meses.
-¿En que calles se registró más ruido, coninciden con las calles más céntricas?
-Supera por mucho el nivel de ruido el nivel perjudicial? (Buscar cuanto es)
-¿Hay más ruido en invierno o en verano?









